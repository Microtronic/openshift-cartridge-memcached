#!/bin/bash -e
set -x

source $OPENSHIFT_CARTRIDGE_SDK_BASH

mkdir -p $OPENSHIFT_MEMCACHED_DIR/{logs,pid}

case "$1" in
	-v|--version) version="$2";;
esac

# build from sources
cd $OPENSHIFT_DATA_DIR
git clone https://github.com/memcached/memcached memcached-$OPENSHIFT_MEMCACHED_VERSION
cd memcached-$OPENSHIFT_MEMCACHED_VERSION
git checkout $OPENSHIFT_MEMCACHED_VERSION
./autogen.sh
./configure --enable-sasl --enable-sasl-pwdb
make -j 2

# install inside cartridge
BIN_DIR="$OPENSHIFT_MEMCACHED_DIR/versions/$version/bin"
mkdir -p $BIN_DIR
cp -fv memcached scripts/memcached-tool $binaries

set_env_var OPENSHIFT_MEMCACHED_PATH_ELEMENT "$OPENSHIFT_MEMCACHED_DIR/versions/$version/bin" $OPENSHIFT_MEMCACHED_DIR/env
